<script>
  const imageInput = document.getElementById("imageInput");
  const preview = document.getElementById("preview");
  const uploadText = document.getElementById("uploadText");

  imageInput.addEventListener("change", () => {
    const file = imageInput.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = () => {
      preview.src = reader.result;
      preview.style.display = "block";
      uploadText.style.display = "none";
    };
    reader.readAsDataURL(file);
  });

  async function submitData() {
    const link = document.getElementById("productLink").value;
    const file = imageInput.files[0];

    if (!link || !file) {
      alert("กรุณาใส่ลิงก์และอัปโหลดรูป");
      return;
    }

    // 1️⃣ แปลงรูปเป็น base64
    const base64 = await toBase64(file);

    // 2️⃣ ส่งรูปไป Google Apps Script
    const gasRes = await fetch("https://script.google.com/macros/s/AKfycby6AQc80SJPbctoqQeLxf_1npozzQ5YhRDx4x6j1rGNzwC9WVbPEiWb3gtTsSWtxWk7/exec", {
      method: "POST",
      body: new URLSearchParams({
        file: base64.split(",")[1],
        name: file.name,
        type: file.type
      })
    });

    const gasData = await gasRes.json();
    if (!gasData.success) {
      alert("อัปโหลดรูปไม่สำเร็จ");
      return;
    }

    // 3️⃣ ส่งข้อมูลต่อไป n8n (ไม่มีไฟล์แล้ว)
    await fetch(
      "https://endoparasitic-convalescently-cristen.ngrok-free.dev/webhook/add-product",
      {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          link,
          imageUrl: gasData.fileUrl
        })
      }
    );

    alert("ส่งข้อมูลเรียบร้อย");
  }

  function toBase64(file) {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = () => resolve(reader.result);
      reader.onerror = reject;
      reader.readAsDataURL(file);
    });
  }
</script>
