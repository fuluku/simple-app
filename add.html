<script>
  const imageInput = document.getElementById("imageInput");
  const preview = document.getElementById("preview");
  const uploadText = document.getElementById("uploadText");

  imageInput.addEventListener("change", () => {
    const file = imageInput.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = () => {
      preview.src = reader.result;
      preview.style.display = "block";
      uploadText.style.display = "none";
    };
    reader.readAsDataURL(file);
  });

  async function submitData() {
    const link = document.getElementById("productLink").value;
    const file = imageInput.files[0];

    if (!link || !file) {
      alert("à¸à¸£à¸¸à¸“à¸²à¹ƒà¸ªà¹ˆà¸¥à¸´à¸‡à¸à¹Œà¹à¸¥à¸°à¸­à¸±à¸›à¹‚à¸«à¸¥à¸”à¸£à¸¹à¸›");
      return;
    }

    // 1ï¸âƒ£ à¹à¸›à¸¥à¸‡à¸£à¸¹à¸›à¹€à¸›à¹‡à¸™ base64
    const base64 = await toBase64(file);

    // 2ï¸âƒ£ à¸ªà¹ˆà¸‡à¸£à¸¹à¸›à¹„à¸› Google Apps Script
    const gasRes = await fetch("ðŸ”¥PUT_GAS_WEBAPP_URL_HEREðŸ”¥", {
      method: "POST",
      body: new URLSearchParams({
        file: base64.split(",")[1],
        name: file.name,
        type: file.type
      })
    });

    const gasData = await gasRes.json();
    if (!gasData.success) {
      alert("à¸­à¸±à¸›à¹‚à¸«à¸¥à¸”à¸£à¸¹à¸›à¹„à¸¡à¹ˆà¸ªà¸³à¹€à¸£à¹‡à¸ˆ");
      return;
    }

    // 3ï¸âƒ£ à¸ªà¹ˆà¸‡à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸•à¹ˆà¸­à¹„à¸› n8n (à¹„à¸¡à¹ˆà¸¡à¸µà¹„à¸Ÿà¸¥à¹Œà¹à¸¥à¹‰à¸§)
    await fetch(
      "https://endoparasitic-convalescently-cristen.ngrok-free.dev/webhook/add-product",
      {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          link,
          imageUrl: gasData.fileUrl
        })
      }
    );

    alert("à¸ªà¹ˆà¸‡à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹€à¸£à¸µà¸¢à¸šà¸£à¹‰à¸­à¸¢");
  }

  function toBase64(file) {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = () => resolve(reader.result);
      reader.onerror = reject;
      reader.readAsDataURL(file);
    });
  }
</script>
